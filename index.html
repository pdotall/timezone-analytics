<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Ithil Anor — Timezone Inference</title>
    <meta name="description" content="Ithil Anor — Sun & Moon themed UTC timezone inference with polygon bands."/>
    <style>
      html,body{margin:0;height:100%}
      #root{min-height:100vh}
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- React + Babel (inline demo) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
      const {useEffect,useRef,useState,useMemo} = React;

      /* ===================== Utilities ===================== */
      const fmtUSD = (n)=> new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2}).format(n);

      const isEvm=(s)=>/^(0x)[0-9a-fA-F]{40}$/.test(s);
      const isSol=(s)=>/^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(s);
      const parseAddresses=(text)=>{
        const parts=String(text||'').split(/[\s,;\n\r]+/).map(s=>s.trim()).filter(Boolean);
        const seen=new Set(); const out=[];
        for(const a of parts){
          let key=null;
          if(isEvm(a)) key=a.toLowerCase();
          else if(isSol(a)) key=a;
          else continue;
          if(seen.has(key)) continue;
          seen.add(key); out.push(a);
        }
        return out;
      };

      const getZoneName=(props={})=>props.tzid||props.TZID||props.time_zone||props.NAME||props.name||'Timezone';

      // same hashing used for consistent pastels
      const pastelFromLabel=(label)=>{
        let h=0; const s=String(label||'');
        for(let i=0;i<s.length;i++) h=(h*31 + s.charCodeAt(i))>>>0;
        return h%360;
      };

      const isFeatureCollection = (obj)=>!!obj && obj.type==='FeatureCollection' && Array.isArray(obj.features);
      const isNumber=(x)=>typeof x==='number' && Number.isFinite(x);
      const isPosition=(p)=>Array.isArray(p)&&p.length>=2&&isNumber(p[0])&&isNumber(p[1]);
      const isLinearRing=(ring)=>Array.isArray(ring)&&ring.length>=4&&ring.every(isPosition);
      const isPolygon=(coords)=>Array.isArray(coords)&&coords.length>0&&coords.every(isLinearRing);
      const isMultiPolygon=(coords)=>Array.isArray(coords)&&coords.length>0&&coords.every(isPolygon);

      function sanitizeFeatureCollection(fcIn){
        try{
          if(!isFeatureCollection(fcIn)) return null;
          const out={type:'FeatureCollection',features:[]};
          for(const f of fcIn.features||[]){
            const g=f?.geometry; if(!g||typeof g!=='object') continue;
            if((g.type==='Polygon' && isPolygon(g.coordinates)) ||
               (g.type==='MultiPolygon' && isMultiPolygon(g.coordinates))){
              out.features.push(f);
            }
          }
          return out.features.length?out:null;
        }catch{return null;}
      }

      // TopoJSON → GeoJSON loader fallback (Natural Earth)
      const TOPO_URL='https://gist.githubusercontent.com/tschaub/cc70281ce4df5358eac38b34409b9ef9/raw/d152ba9e83d7733d9fb5f37f52202c0fcead834a/timezones.json';

      // Small fallback polygon (always valid)
      const FALLBACK_FC = {
        type:'FeatureCollection',
        features:[{
          type:'Feature',
          properties:{ tzid:'UTC (fallback)'},
          geometry:{ type:'Polygon', coordinates:[[[-5,45],[5,45],[5,35],[-5,35],[-5,45]]] }
        }]
      };

      // SIM client (no backend)
      const SIM_BASE = 'https://smart-money.pdotcapital.workers.dev/v1';
      async function fetchSimActivity(address){
        const url = `${SIM_BASE}/evm/activity/${address}?type=send,receive,mint,burn&limit=1000&sort_by=block_time&sort_order=asc`;
        const r = await fetch(url);
        if(!r.ok) throw new Error(`SIM HTTP ${r.status}`);
        return r.json();
      }

      // Compute hourly UTC counts from SIM activity (all chains)
      function buildUtcHourlyCounts(activity){
        const counts = Array(24).fill(0);
        for(const ev of activity?.activity||[]){
          const ts = Date.parse(ev.block_time); // ← already UTC
          if(!Number.isFinite(ts)) continue;
          const h = new Date(ts).getUTCHours();
          counts[h] += 1;
        }
        return counts;
      }

      // STRICT port of your SQL scoring (mult = 5.0, high=10–15, low=1–5)
      function scoreOffsetsExactlyLikeSQL(counts){
        const mult = 5.0;
        const HOURS = [...Array(24).keys()];
        const OFFSETS = Array.from({length:27},(_,i)=>i-12); // -12 … +14

        // helper: median of values selected by mask
        function maskedMedian(vals, maskFn){
          const bucket=[];
          for(const h of HOURS) if(maskFn(h)) bucket.push(counts[h]);
          if(!bucket.length) return 0;
          const s=bucket.slice().sort((a,b)=>a-b);
          const mid=Math.floor(s.length/2);
          return s.length%2? s[mid] : (s[mid-1]+s[mid])/2;
        }

        function inHigh(local){ return local>=10 && local<=15; }
        function inLow(local){  return local>= 1 && local<= 5; }

        const rows=[];
        for(const offset of OFFSETS){
          const localFromUTC = (h)=> (h + offset + 24) % 24;

          const med_10_15 = maskedMedian(counts, (utcH)=> inHigh(localFromUTC(utcH)));
          const med_1_5   = maskedMedian(counts, (utcH)=> inLow(localFromUTC(utcH)));

          // bars_high_over_mult counts high hours whose utc_count ≥ mult * med_1_5
          let bars_high_over_mult = 0;
          for(const utcH of HOURS){
            const local = localFromUTC(utcH);
            if(inHigh(local) && counts[utcH] >= mult * (med_1_5||0)) bars_high_over_mult++;
          }

          const ratio = med_1_5===0 ? null : (med_10_15 / med_1_5);
          const passes_rule = (med_1_5>0) && (med_10_15 >= mult * med_1_5);

          rows.push({offset, med_10_15, med_1_5, ratio, bars_high_over_mult, passes_rule});
        }

        // ORDER BY ratio DESC NULLS LAST, bars_high_over_mult DESC
        rows.sort((a,b)=>{
          const ar = (a.ratio==null?-Infinity:a.ratio);
          const br = (b.ratio==null?-Infinity:b.ratio);
          if(br!==ar) return br-ar;
          return (b.bars_high_over_mult)-(a.bars_high_over_mult);
        });

        return rows[0]; // best for this address
      }

      // Label helper identical to your SQL
      function utcLabelFromOffset(off){
        if(off<0) return `UTC - ${Math.abs(off)}`;
        if(off>0) return `UTC + ${off}`;
        return 'UTC ± 0';
      }

      // Live offset label for IANA tzid (tooltip nicety)
      function currentOffsetLabel(tzid, when=new Date()){
        try{
          const fmt=new Intl.DateTimeFormat('en-US',{timeZone:tzid,hour12:false,timeZoneName:'shortOffset'});
          const parts=fmt.formatToParts(when);
          const off=parts.find(p=>p.type==='timeZoneName')?.value||'UTC±0';
          const m=off.match(/([UG]MT|UTC)\s*([+-]\d{1,2})(?::?(\d{2}))?/i);
          if(!m) return 'UTC±00:00';
          const hours=parseInt(m[2],10);
          const sign=hours>=0?'+':'-';
          const h=String(Math.abs(hours)).padStart(2,'0');
          const mm=m[3]?m[3]:'00';
          return `UTC${sign}${h}:${mm}`;
        }catch{return 'UTC±00:00';}
      }

      // CSV export
      function toCSV(rows){
        const esc = (v)=> `"${String(v??'').replace(/"/g,'""')}"`;
        const header = ['Address','UTC Offset','UTC Label','IANA Example','Passes Rule','med_10_15','med_1_5','Ratio','Bars ≥ mult','UTC Label Count'];
        const lines = [header.map(esc).join(',')];
        for(const r of rows){
          lines.push([
            r.address,
            r.utc_offset_hours,
            r.utc_label,
            r.iana_tz_example||'',
            r.passes_rule,
            r.med_10_15,
            r.med_1_5,
            r.ratio==null?'':r.ratio,
            r.bars_high_over_mult,
            r.utc_label_count
          ].map(esc).join(','));
        }
        return lines.join('\n');
      }

      // Confirm Modal
      function Modal({open,onClose,onConfirm,count,pricePer=0.5}){
        if(!open) return null;
        const total = count * pricePer;
        return (
          <div style={{
            position:'fixed', inset:0, background:'rgba(0,0,0,.35)', display:'grid', placeItems:'center', zIndex:1000
          }}
            onClick={(e)=>{ if(e.target===e.currentTarget) onClose(); }}
          >
            <div style={{
              width:'min(92vw,420px)',
              borderRadius:14,
              border:'1px solid var(--stroke)',
              background:'var(--card)',
              boxShadow:'0 20px 60px rgba(0,0,0,.35)',
              backdropFilter:'blur(8px)',
              padding:18
            }}>
              <div style={{display:'flex',alignItems:'center',gap:10,marginBottom:8}}>
                <HeaderArt/>
                <div style={{fontWeight:800,letterSpacing:.3}}>Confirm addresses</div>
              </div>
              <div style={{fontSize:14,color:'var(--muted)'}}>
                You are about to analyze <b style={{color:'var(--text)'}}>{count}</b> address{count===1?'':'es'}.
                <div style={{marginTop:6}}>
                  Price: <b style={{color:'var(--text)'}}>{fmtUSD(pricePer)}</b> per address
                </div>
                <div style={{marginTop:2}}>
                  Total: <b style={{color:'var(--text)'}}>{fmtUSD(total)}</b>
                </div>
              </div>
              <div style={{display:'flex',gap:8,justifyContent:'flex-end',marginTop:14}}>
                <button className="btn btn-plain" onClick={onClose}>Cancel</button>
                <button className="btn btn-primary" onClick={()=>onConfirm(total)}>Confirm & Run</button>
              </div>
              <div style={{marginTop:8, fontSize:11, color:'var(--muted)'}}>Note: demo UI only — no card is charged here.</div>
            </div>
          </div>
        );
      }

      // Header icon (Sun + Moon minimal)
      const HeaderArt = () => (
        <svg width="42" height="24" viewBox="0 0 42 24" fill="none" stroke="currentColor" strokeWidth="1.2" aria-hidden="true">
          <!-- sun -->
          <circle cx="10" cy="12" r="4"/>
          <path d="M10 2v2M10 20v2M2 12H0M20 12h-2M4.9 6.9l-1.4-1.4M17.5 19.5l-1.4-1.4M4.9 17.1l-1.4 1.4M17.5 4.5l-1.4 1.4"/>
          <!-- moon -->
          <path d="M33 6.5c-3 1-5 3.9-5 7.2 0 3.9 3.1 7 7 7 3.3 0 6.2-2 7.2-5 -1.1.5-2.3.8-3.6.8 -3.4 0-6.6-2.4-7.6-5.9z" fill="currentColor" stroke="none" opacity="0.8"/>
        </svg>
      );

      function App(){
        const mapEl=useRef(null);
        const mapRef=useRef(null);
        const tzLayerRef=useRef(null);

        // theme — default SUN
        const [theme,setTheme]=useState(()=>{
          const t=localStorage.getItem('ithil-theme');
          return t==='moon'?'moon':'sun';
        });
        useEffect(()=>{ document.documentElement.dataset.theme=theme; localStorage.setItem('ithil-theme',theme); },[theme]);

        const [addressInput,setAddressInput]=useState('');
        const [addresses,setAddresses]=useState([]);
        const [detecting,setDetecting]=useState(false);
        const [detectError,setDetectError]=useState('');
        const [status,setStatus]=useState('');
        const [loading,setLoading]=useState(false);

        // table rows: one row per address
        const [rows,setRows]=useState([]);
        // map gradient: zone label → count
        const [zoneCounts,setZoneCounts]=useState({});

        // Confirm modal
        const [isModalOpen,setModalOpen]=useState(false);

        // Map data
        const [geoData,setGeoData]=useState(FALLBACK_FC);

        // loader helpers
        const loadScript=(src)=>new Promise((resolve,reject)=>{
          const existing=document.querySelector(`script[src="${src}"]`);
          if(existing){ if(existing.dataset.loaded==='true') return resolve();
            existing.addEventListener('load',()=>resolve());
            existing.addEventListener('error',reject);
            return;
          }
          const s=document.createElement('script'); s.src=src; s.async=true;
          s.onload=()=>{ s.dataset.loaded='true'; resolve(); };
          s.onerror=reject; document.body.appendChild(s);
        });
        const loadCSS=(href)=>new Promise((resolve,reject)=>{
          const existing=document.querySelector(`link[href="${href}"]`);
          if(existing) return resolve();
          const l=document.createElement('link'); l.rel='stylesheet'; l.href=href;
          l.onload=resolve; l.onerror=reject; document.head.appendChild(l);
        });

        // init map
        useEffect(()=>{
          let cancelled=false;
          (async()=>{
            try{
              await loadCSS('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');
              await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
              const L=window.L; if(!L) throw new Error('Leaflet failed to load');
              mapRef.current=L.map(mapEl.current,{minZoom:1.5,worldCopyJump:true,zoomSnap:.25,zoomDelta:.25}).setView([20,0],2.2);
              L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{opacity: theme==='sun'?0.5:0.35, attribution:'&copy; OSM'}).addTo(mapRef.current);

              // Load NE Topo → GeoJSON
              await loadScript('https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js');
              try{
                setLoading(true);
                const r=await fetch(TOPO_URL,{cache:'reload'});
                if(!r.ok) throw new Error(`TopoJSON HTTP ${r.status}`);
                const topo=await r.json();
                const keys=Object.keys(topo?.objects||{});
                if(!keys.length) throw new Error('TopoJSON: no objects');
                const bestKey=keys.find(k=>/time/i.test(k))||keys[0];
                const fc=window.topojson.feature(topo, topo.objects[bestKey]);
                const sanitized=sanitizeFeatureCollection(fc);
                setGeoData(sanitized||FALLBACK_FC);
                setStatus(`Loaded ${sanitized?.features?.length ?? 1} zones.`);
              }catch(e){
                setGeoData(FALLBACK_FC);
                setStatus('Loaded fallback');
              }finally{ setLoading(false); }

              renderZones(); // with initial (empty) counts

              mapRef.current.on('click',(e)=>{
                if(!e.originalEvent.target.closest?.('.leaflet-interactive')){/* no-op */}
              });
            }catch(err){ console.error(err); setStatus(err.message||String(err)); }
          })();
          return ()=>{cancelled=true; try{mapRef.current?.remove();}catch{}};
          // eslint-disable-next-line react-hooks/exhaustive-deps
        },[]);

        // re-render polygons whenever geoData or counts or theme change
        useEffect(()=>{ if(mapRef.current) renderZones(); /* eslint-disable-next-line */ },[geoData, zoneCounts, theme]);

        function renderZones(){
          const L=window.L; if(!L||!mapRef.current||!geoData) return;
          if(tzLayerRef.current){ try{tzLayerRef.current.remove();}catch{} tzLayerRef.current=null; }

          // find max for gradient scaling
          const counts = zoneCounts;
          const max = Object.values(counts).reduce((m,v)=> v>m?v:m, 0);

          function zoneColor(label){
            const count = counts[label]||0;
            if(count===0) return 'transparent';
            // base hue from label for deterministic, then darkness by count
            const hue = pastelFromLabel(label);
            const light = max>0 ? (80 - (count/max)*40) : 80; // 80% → 40% as count grows
            return `hsl(${hue} 85% ${light}%)`;
          }

          const style=(feature)=>{
            const tzid=getZoneName(feature?.properties||{});
            const fill = zoneColor(tzid);
            const stroke = fill==='transparent' ? (theme==='sun'?'#c8cdd9':'#5b6477') : fill;
            return { color: stroke, weight: 1, fillColor: fill, fillOpacity: fill==='transparent'?0:0.65 };
          };

          const onEachFeature=(feature,layer)=>{
            const tzid=getZoneName(feature?.properties||{});
            const count=zoneCounts[tzid]||0;
            layer.bindTooltip(`${tzid} · ${currentOffsetLabel(tzid)} · ${count}`,{sticky:true,direction:'top'});
          };

          tzLayerRef.current = L.geoJSON(geoData,{style,onEachFeature}).addTo(mapRef.current);
        }

        // handle confirm: open modal with parsed addresses
        function openConfirm(){
          const parsed = parseAddresses(addressInput);
          setAddresses(parsed);
          if(parsed.length===0){
            setDetectError('No valid addresses found.');
            return;
          }
          setDetectError('');
          setModalOpen(true);
        }

        // When modal confirms, run detection
        async function handleConfirmRun(){
          setModalOpen(false);
          await handleDetect();
        }

        // detection pipeline (SIM only; no backend)
        async function handleDetect(){
          const addrs = addresses;
          if(!addrs.length) return;
          setDetecting(true); setDetectError('');
          try{
            // 1) Per-address activity → hourly counts
            const perAddr = [];
            for(const a of addrs){
              const js = await fetchSimActivity(a);
              const counts = buildUtcHourlyCounts(js);
              const best = scoreOffsetsExactlyLikeSQL(counts);

              const utc_offset_hours = best?.offset??0;
              const utc_label = utcLabelFromOffset(utc_offset_hours);

              // IANA example mapping (as in your SQL list)
              const tzMap = {
                "-12":'Etc/GMT+12', "-11":'Pacific/Pago_Pago', "-10":'Pacific/Honolulu',
                 "-9":'America/Anchorage', "-8":'America/Los_Angeles', "-7":'America/Denver',
                 "-6":'America/Chicago', "-5":'America/New_York', "-4":'America/Halifax',
                 "-3":'America/Sao_Paulo', "-2":'America/Noronha', "-1":'Atlantic/Cape_Verde',
                  "0":'Europe/London', "1":'Europe/Berlin', "2":'Europe/Eastern_Europe',
                  "3":'Europe/Moscow', "4":'Asia/Dubai', "5":'Asia/Karachi',
                  "6":'Asia/Dhaka', "7":'Asia/Bangkok', "8":'Asia/Singapore',
                  "9":'Asia/Tokyo', "10":'Australia/Sydney', "11":'Pacific/Guadalcanal',
                  "12":'Pacific/Auckland', "13":'Pacific/Tongatapu', "14":'Pacific/Kiritimati'
              };
              const iana = tzMap[String(utc_offset_hours)] || '';

              perAddr.push({
                address:a,
                utc_offset_hours,
                utc_label,
                iana_tz_example: iana,
                passes_rule: !!best?.passes_rule,
                med_10_15: best?.med_10_15 ?? 0,
                med_1_5: best?.med_1_5 ?? 0,
                ratio: best?.ratio ?? null,
                bars_high_over_mult: best?.bars_high_over_mult ?? 0
              });
            }

            // 2) Count per label and decorate rows with utc_label_count
            const labelCount = perAddr.reduce((m,r)=>{ m[r.utc_label]=(m[r.utc_label]||0)+1; return m; },{});
            const finalRows = perAddr.map(r=>({...r, utc_label_count: labelCount[r.utc_label]}));
            setRows(finalRows);

            // 3) Update map gradient using labels → counts
            setZoneCounts(labelCount);

            setStatus(`Analyzed ${finalRows.length} address${finalRows.length===1?'':'es'}.`);
          }catch(err){
            console.error(err);
            setDetectError(err.message||'Failed to detect timezones');
          }finally{
            setDetecting(false);
          }
        }

        function downloadCSV(){
          const csv = toCSV(rows);
          const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href=url; a.download='ithil-anor-timezones.csv';
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
        }

        // theme styles
        return (
          <div style={{
            maxWidth:1100, margin:'0 auto', padding:16,
            fontFamily:'Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial',
            color:'var(--text)'
          }}>
            <style>{`
              :root{
                --card: rgba(255,255,255,0.06);
                --stroke: rgba(255,255,255,0.14);
                --text: #0b0f1a;
                --muted:#5d6578;
                --bg: #ffffff;
                --accent: #C9A034; /* gold */
              }
              :root[data-theme="moon"]{
                --card: rgba(255,255,255,0.04);
                --stroke: rgba(255,255,255,0.10);
                --text: #e6e9f2;
                --muted:#a2a9bc;
                --bg: #0b1020;
                --accent: #9aa3b2;
              }
              html,body{background:var(--bg)}
              .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.20); backdrop-filter: blur(8px);}
              .btn{border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; transition:transform .12s ease, box-shadow .2s ease;}
              .btn:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.18);}
              .btn-primary{ background: linear-gradient(135deg,var(--accent),#e7c56a); color: #1a1a1a;}
              :root[data-theme="moon"] .btn-primary{ background: linear-gradient(135deg,#3a4354,#626b7c); color:#f3f5f9;}
              .btn-plain{ background: transparent; color: var(--text); border: 1px solid var(--stroke);}
              .textarea{ width:100%; height:140px; background: transparent; color: var(--text); border:1px solid var(--stroke); border-radius:12px; padding:12px; outline:none;}
              .input{ width:100%; height:40px; background: transparent; color: var(--text); border:1px solid var(--stroke); border-radius:10px; padding:0 12px; outline:none;}
              .row{ display:flex; align-items:center; gap:8px;}
              .space{ flex:1;}
              .table{ width:100%; border-collapse:collapse; font-size:13px; color:var(--text);}
              .th,.td{ padding:10px 8px; border-bottom:1px solid var(--stroke);}
              .thead{ position:sticky; top:0; background: var(--bg); z-index:1; }
              .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); }
              .toggle{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); cursor:pointer; user-select:none;}
              .toggle .knob{ width:16px; height:16px; border:1px solid var(--stroke); border-radius:50%; display:inline-block; background:var(--bg); }
              .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.4px;}
              .brand small{ font-weight:700; opacity:.7; }
            `}</style>

            <div className="row" style={{marginBottom:12}}>
              <div className="brand" title="Ithil Anor">
                <HeaderArt/>
                <span>Ithil Anor</span>
                <small>sun & moon</small>
              </div>
              <div className="space"></div>
              <div
                className="toggle"
                onClick={()=>setTheme(t=>t==='sun'?'moon':'sun')}
                title="Toggle theme"
              >
                <span>{theme==='sun'?'Sun':'Moon'}</span>
                <span className="knob"></span>
              </div>
            </div>

            <p style={{margin:'6px 0 0', color:'var(--muted)'}}>Paste addresses, click <b style={{color:'var(--text)'}}>Confirm</b> to approve pricing, then we’ll detect and shade timezone bands.</p>

            <div style={{display:'grid', gridTemplateColumns:'1.45fr .55fr', gap:16, marginTop:14}}>
              <div className="card" style={{padding:14}}>
                <div className="row" style={{marginBottom:10}}>
                  <span style={{fontWeight:800}}>Map</span>
                  <div className="space"></div>
                  <span style={{fontSize:12, color:'var(--muted)'}}>{loading ? 'Loading timezones…' : status}</span>
                </div>
                <div ref={mapEl} style={{height:560, borderRadius:12, overflow:'hidden', boxShadow:'inset 0 0 0 1px var(--stroke)'}} />
                <div style={{marginTop:10, fontSize:12, color:'var(--muted)'}}>
                  Darker fill = more addresses labeled with that timezone.
                </div>
              </div>

              <div className="card" style={{padding:14}}>
                <div style={{marginBottom:10, fontWeight:800}}>Addresses</div>
                <textarea
                  className="textarea"
                  placeholder="Paste EVM (0x...) or Solana base58 addresses (one per line, or separated by space/comma)"
                  value={addressInput}
                  onChange={(e)=>setAddressInput(e.target.value)}
                />
                <div className="row" style={{marginTop:8}}>
                  <button className="btn btn-primary" onClick={openConfirm} disabled={detecting}>
                    {detecting ? 'Working…' : 'Confirm'}
                  </button>
                  <button className="btn btn-plain" onClick={downloadCSV} disabled={!rows.length}>Download CSV</button>
                  <div className="space"></div>
                  <span style={{fontSize:12, color:'var(--muted)'}}>
                    {addresses.length ? `${addresses.length} address${addresses.length===1?'':'es'} ready` : 'No parsed addresses yet'}
                  </span>
                </div>
                {detectError && <div style={{marginTop:8, fontSize:12, color:'#d64545'}}>{detectError}</div>}
              </div>
            </div>

            <div className="card" style={{marginTop:18, padding:12}}>
              <div style={{fontWeight:800, marginBottom:8}}>Results</div>
              <div style={{overflowX:'auto'}}>
                <table className="table">
                  <thead>
                    <tr className="thead">
                      <th className="th">Address</th>
                      <th className="th">UTC Offset</th>
                      <th className="th">UTC Label</th>
                      <th className="th">IANA Example</th>
                      <th className="th">Passes Rule</th>
                      <th className="th">med_10_15</th>
                      <th className="th">med_1_5</th>
                      <th className="th">Ratio</th>
                      <th className="th">Bars ≥ mult</th>
                      <th className="th">UTC Label Count</th>
                    </tr>
                  </thead>
                  <tbody>
                    {rows.length===0 ? (
                      <tr><td className="td" colSpan={10} style={{opacity:.7}}>No results yet — paste addresses and Confirm.</td></tr>
                    ): rows.map((r,i)=>(
                      <tr key={r.address+'_'+i}>
                        <td className="td" style={{fontFamily:'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace'}}>{r.address}</td>
                        <td className="td">{r.utc_offset_hours}</td>
                        <td className="td">{r.utc_label}</td>
                        <td className="td">{r.iana_tz_example}</td>
                        <td className="td">{String(r.passes_rule)}</td>
                        <td className="td">{r.med_10_15}</td>
                        <td className="td">{r.med_1_5}</td>
                        <td className="td">{r.ratio==null?'':r.ratio.toFixed ? r.ratio.toFixed(3) : r.ratio}</td>
                        <td className="td">{r.bars_high_over_mult}</td>
                        <td className="td">{r.utc_label_count}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            <div style={{marginTop:8, fontSize:12, color:'var(--muted)'}}>
              Data: Natural Earth time zones (TopoJSON) · Basemap © OSM · SIM for activity
            </div>

            <Modal
              open={isModalOpen}
              onClose={()=>setModalOpen(false)}
              onConfirm={handleConfirmRun}
              count={parseAddresses(addressInput).length}
              pricePer={0.5}
            />
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App/>);
    </script>
  </body>
</html>
