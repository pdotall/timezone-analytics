<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ithil Anor — Timezone Inference</title>
  <meta name="description" content="Ithil Anor — minimal, sharp timezone inference from on-chain activity (SQL-accurate)."/>

  <style>
    :root{
      --bg: #0b0e13;
      --panel: #0f1218;
      --panel-2: #121722;
      --border: #1b2332;
      --muted: #9aa3b2;
      --text: #eef3ff;
      --text-2: #c9d1e1;
      --accent: #5b8cff;
      --accent-2: #88aaff;
      --ok: #63e6be;
      --danger: #ff6b6b;

      --hue: 220;
      --radius: 12px;
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body[data-theme="sun"]{
      --bg: #ffffff;
      --panel: #ffffff;
      --panel-2: #fafbfe;
      --border: #e9edf5;
      --muted: #6c778a;
      --text: #101318;
      --text-2: #232a34;
      --accent: #b6922e;
      --accent-2: #e6c561;
      --ok: #2f9e44;
      --danger: #d63939;

      --hue: 42;
      --shadow: 0 10px 24px rgba(10,15,20,.08);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:var(--sans);}
    .wrap{max-width:1180px;margin:0 auto;padding:18px;}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:12px 16px;margin-bottom:14px;border:1px solid var(--border);
      background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border-radius:var(--radius);box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.25px;}
    .brand-title{font-size:19px}
    .brand-sub{font-size:12px;color:var(--muted)}
    .status{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1.55fr .85fr;gap:14px}
    .card{border:1px solid var(--border);background:var(--panel);border-radius:var(--radius);box-shadow:var(--shadow);}
    .card-h{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
    .card-b{padding:12px 14px}
    .muted{color:var(--muted)}
    .mono{font-family:var(--mono)}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input{
      width:100%;height:132px;background:transparent;border:1px solid var(--border);
      border-radius:10px;color:var(--text);padding:10px;font-family:var(--mono);font-size:12px;
    }
    .btn{
      border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;font-weight:700;
      border-radius:10px;cursor:pointer;transition:all .15s ease;
    }
    .btn:hover{transform:translateY(-1px);border-color:#2a3550}
    .btn:focus{outline:2px solid var(--accent-2);outline-offset:1px}
    .btn.primary{background:linear-gradient(180deg,var(--accent),#4c79e8);border-color:#4c79e8;color:#fff}
    body[data-theme="sun"] .btn.primary{
      background:linear-gradient(180deg,#f0d67a,var(--accent));border-color:var(--accent);color:#5d4912;
    }
    .btn.ghost{background:transparent}
    #map{height:560px;border-radius:10px;overflow:hidden;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)}
    body[data-theme="sun"] #map{box-shadow:inset 0 0 0 1px rgba(0,0,0,.04)}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      background:transparent;font-size:12px;color:var(--text-2)
    }
    .chip .dot{width:8px;height:8px;border-radius:999px;background:var(--accent);opacity:.85}
    .chip button{border:0;background:transparent;color:var(--muted);cursor:pointer;padding:0 2px}
    .chip button:hover{color:var(--text)}
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    thead th{position:sticky;top:0;background:var(--panel-2);border-bottom:1px solid var(--border);text-align:left;padding:10px 8px;color:var(--text-2)}
    tbody td{padding:10px 8px;border-bottom:1px solid rgba(0,0,0,.06)}
    body[data-theme="sun"] tbody td{border-bottom:1px solid rgba(0,0,0,.04)}
    tbody tr:hover{background:rgba(0,0,0,.06)}
    body[data-theme="sun"] tbody tr:hover{background:#f8f9fb}
    .theme-toggle{display:flex;align-items:center;gap:10px}
    .toggle-btn{
      display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);
      background:transparent;border-radius:999px;padding:6px 10px;cursor:pointer;color:var(--text-2);
    }
    .toggle-btn:hover{border-color:var(--accent)}
    .toggle-ico{width:18px;height:18px;display:block}

    /* Modal (glassy) */
    .modal-backdrop{
      position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:color-mix(in oklab, black 30%, transparent); /* supported modern browsers */
      backdrop-filter: blur(10px) saturate(120%);
      -webkit-backdrop-filter: blur(10px) saturate(120%);
      z-index:999;
    }
    .modal-card{
      width:min(520px,92vw);
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--panel) 86%, transparent), color-mix(in oklab, var(--panel-2) 86%, transparent));
      box-shadow:0 30px 80px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      color:var(--text);
    }
    .modal-h{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;font-weight:800}
    .modal-b{font-size:14px;color:var(--text-2)}
    .modal-f{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}

    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;gap:12px}
      #map{height:460px}
    }
  </style>
</head>
<body>
<div class="wrap" id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel">
  const { useEffect, useRef, useState } = React;

  /* ======================= DATA CONFIG ======================= */
  const SIM_PROXY = 'https://smart-money.pdotcapital.workers.dev/v1';
  const NE_TOPO_URL =
    'https://gist.githubusercontent.com/tschaub/cc70281ce4df5358eac38b34409b9ef9/raw/d152ba9e83d7733d9fb5f37f52202c0fcead834a/timezones.json';
  const MULT = 5.0;
  const PRICE_PER_ADDRESS = 0.5;

  const IANA_EXAMPLE = new Map([
    [-12,'Etc/GMT+12'],[-11,'Pacific/Pago_Pago'],[-10,'Pacific/Honolulu'],[-9,'America/Anchorage'],
    [-8,'America/Los_Angeles'],[-7,'America/Denver'],[-6,'America/Chicago'],[-5,'America/New_York'],
    [-4,'America/Halifax'],[-3,'America/Sao_Paulo'],[-2,'America/Noronha'],[-1,'Atlantic/Cape_Verde'],
    [0,'Europe/London'],[1,'Europe/Berlin'],[2,'Europe/Eastern_Europe'],[3,'Europe/Moscow'],
    [4,'Asia/Dubai'],[5,'Asia/Karachi'],[6,'Asia/Dhaka'],[7,'Asia/Bangkok'],
    [8,'Asia/Singapore'],[9,'Asia/Tokyo'],[10,'Australia/Sydney'],[11,'Pacific/Guadalcanal'],
    [12,'Pacific/Auckland'],[13,'Pacific/Tongatapu'],[14,'Pacific/Kiritimati']
  ]);

  /* ======================= HELPERS ======================= */
  const getZoneName = (props = {}) =>
    props.tzid || props.TZID || props.time_zone || props.NAME || props.name || 'Timezone';

  function polyToUiLabel(raw) {
    if (!raw) return 'UTC ± 0';
    const m = String(raw).match(/UTC\s*([+-])\s*(\d{1,2})/i);
    if (!m) return String(raw).replace('UTC+0','UTC ± 0').replace('UTC-0','UTC ± 0');
    const sign = m[1] === '-' ? '-' : '+';
    const h = String(parseInt(m[2],10));
    if (h === '0') return 'UTC ± 0';
    return `UTC ${sign} ${h}`;
  }
  const offsetToUiLabel = (ofs) => ofs===0 ? 'UTC ± 0' : (ofs>0?`UTC + ${ofs}`:`UTC - ${Math.abs(ofs)}`);

  const isEvm = (s) => /^(0x)[0-9a-fA-F]{40}$/.test(s);
  const parseAddresses = (txt) => {
    const parts = String(txt||'').split(/[\s,;\n\r]+/).map(s=>s.trim()).filter(Boolean);
    const seen = new Set(), out = [];
    for (const addr of parts){
      if (isEvm(addr)){
        const key = addr.toLowerCase();
        if (!seen.has(key)){ seen.add(key); out.push(addr); }
      }
    }
    return out;
  };

  const isFC=(o)=>!!o && o.type==='FeatureCollection' && Array.isArray(o.features);
  const isNum=(x)=>typeof x==='number' && Number.isFinite(x);
  const isPos=(p)=>Array.isArray(p)&&p.length>=2&&isNum(p[0])&&isNum(p[1]);
  const isRing=(r)=>Array.isArray(r)&&r.length>=4&&r.every(isPos);
  const isPoly=(c)=>Array.isArray(c)&&c.length>0&&c.every(isRing);
  const isMulti=(c)=>Array.isArray(c)&&c.length>0&&c.every(isPoly);

  function sanitizeFC(fc){
    try{
      if(!isFC(fc)) return null;
      const out={type:'FeatureCollection',features:[]};
      for(const f of fc.features||[]){
        const g=f?.geometry;
        if(!g||typeof g!=='object') continue;
        if(g.type==='Polygon'&&isPoly(g.coordinates)) out.features.push(f);
        else if(g.type==='MultiPolygon'&&isMulti(g.coordinates)) out.features.push(f);
      }
      return out.features.length?out:null;
    }catch{return null;}
  }

  const FALLBACK_FC = {
    type:'FeatureCollection',
    features:[{type:'Feature',properties:{tzid:'UTC ± 0 (fallback)'},
      geometry:{type:'Polygon',coordinates:[[[-5,45],[5,45],[5,35],[-5,35],[-5,45]]]}}]
  };

  function median(v){
    if(!v || v.length===0) return null;
    const a=v.slice().sort((x,y)=>x-y); const n=a.length; const m=Math.floor(n/2);
    return n%2? a[m] : (a[m-1]+a[m])/2;
  }

  function buildHourMap(){
    const map=new Map();
    for(let ofs=-12; ofs<=14; ofs++){
      const high=new Set(), low=new Set();
      for(let h=0;h<24;h++){
        const local=(h+ofs+24)%24;
        if(local>=10 && local<=15) high.add(h);
        if(local>=1  && local<=5 ) low.add(h);
      }
      map.set(ofs,{high,low});
    }
    return map;
  }
  const HOUR_MAP = buildHourMap();

  function getHue(){
    const root = getComputedStyle(document.body);
    const v = root.getPropertyValue('--hue').trim();
    const h = parseFloat(v); return Number.isFinite(h) ? h : 220;
  }
  function colorForCount(count,max){
    if(!max || count<=0) return null;
    const t=Math.max(0,Math.min(1,count/max));
    const hue = getHue();
    const sat = document.body.dataset.theme === 'sun' ? 85 : 90;
    const l = document.body.dataset.theme === 'sun'
      ? (90 - 45*t)
      : (85 - 45*t);
    return `hsl(${hue} ${sat}% ${l}%)`;
  }

  /* ======= Fetch across all chains & full history, send+receive only ======= */
  async function fetchTxHoursForAddress(address){
    let cursor=null;
    const buckets = new Array(24).fill(0);
    while(true){
      const url = new URL(`${SIM_PROXY}/evm/activity/${address}`);
      url.searchParams.set('type','send,receive');
      url.searchParams.set('limit','1000');
      if(cursor) url.searchParams.set('offset', cursor);

      const r = await fetch(url.toString(),{headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error(`SIM /activity HTTP ${r.status}`);
      const js = await r.json();
      const acts = Array.isArray(js.activity) ? js.activity : [];
      for(const ev of acts){
        const h = new Date(ev.block_time).getUTCHours();
        buckets[h] += 1;
      }
      cursor = js.next_offset || null;
      if(!cursor || acts.length===0) break;
    }
    const m = new Map();
    for(let h=0; h<24; h++) if (buckets[h] > 0) m.set(h, buckets[h]);
    return m;
  }

  function predictTimezoneFromCountsSQL(countMap){
    let best=null;
    for(let ofs=-12; ofs<=14; ofs++){
      const {high,low}=HOUR_MAP.get(ofs);
      const highVals=[], lowVals=[];
      for(const h of high){ if(countMap.has(h)) highVals.push(countMap.get(h)); }
      for(const h of low ){ if(countMap.has(h))  lowVals.push(countMap.get(h)); }

      const medHigh=median(highVals);
      const medLow =median(lowVals);
      let ratio=null;
      if(medLow!==null && medLow!==0) ratio = medHigh!==null ? (medHigh/medLow) : null;

      let bars=0;
      if(medLow!==null && medLow!==0){
        const thr=MULT*medLow;
        for(const h of high){
          const v=countMap.get(h);
          if(typeof v==='number' && v>=thr) bars++;
        }
      }
      const passes=(medLow!==null && medLow>0) && (medHigh!==null && medHigh>=MULT*medLow);

      const row={offset:ofs,med_10_15:medHigh,med_1_5:medLow,ratio,bars_high_over_mult:bars,passes_rule:passes};
      const better=(()=>{
        if(!best) return true;
        const a=row, b=best;
        if(a.ratio===null && b.ratio===null){
          if(a.bars_high_over_mult!==b.bars_high_over_mult) return a.bars_high_over_mult>b.bars_high_over_mult;
          return false;
        }
        if(a.ratio===null) return false;
        if(b.ratio===null) return true;
        if(a.ratio!==b.ratio) return a.ratio>b.ratio;
        if(a.bars_high_over_mult!==b.bars_high_over_mult) return a.bars_high_over_mult>b.bars_high_over_mult;
        return false;
      })();
      if(better) best=row;
    }
    const ofs=best?.offset ?? 0;
    return {
      utc_offset_hours: ofs,
      utc_label: ofs===0 ? 'UTC ± 0' : (ofs>0?`UTC + ${ofs}`:`UTC - ${Math.abs(ofs)}`),
      iana_tz_example: IANA_EXAMPLE.get(ofs) || 'Etc/UTC',
      passes_rule: !!best?.passes_rule,
      med_10_15: best?.med_10_15 ?? null,
      med_1_5:   best?.med_1_5   ?? null,
      ratio: best?.ratio ?? null,
      bars_high_over_mult: best?.bars_high_over_mult ?? 0
    };
  }

  const SunIcon = ({className}) => (
    <svg className={className||'toggle-ico'} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round">
      <circle cx="12" cy="12" r="4"/>
      <path d="M12 2v2M12 20v2M4 12H2M22 12h-2M5 5l-1.4-1.4M20.4 20.4 19 19M19 5l1.4-1.4M4 20.4 5.4 19"/>
    </svg>
  );
  const MoonIcon = ({className}) => (
    <svg className={className||'toggle-ico'} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.6" strokeLinecap="round">
      <path d="M21 12.8A8.5 8.5 0 1 1 11.2 3 7 7 0 0 0 21 12.8Z"/>
    </svg>
  );

  function App(){
    const [theme,setTheme]=useState(()=>{
      const t=localStorage.getItem('ithil-theme');
      return t ? t : 'sun';  /* sun default */
    });
    useEffect(()=>{ document.body.setAttribute('data-theme', theme==='sun'?'sun':'moon'); localStorage.setItem('ithil-theme',theme); },[theme]);

    const mapEl=useRef(null), mapRef=useRef(null), tzLayerRef=useRef(null);
    const [addresses,setAddresses]=useState([]);
    const [addressInput,setAddressInput]=useState('');
    const [status,setStatus]=useState('');
    const [loading,setLoading]=useState(false);
    const [detecting,setDetecting]=useState(false);
    const [detectError,setDetectError]=useState('');
    const [zoneAddresses,setZoneAddresses]=useState({});
    const zoneAddressesRef=useRef(zoneAddresses);
    useEffect(()=>{ zoneAddressesRef.current=zoneAddresses; },[zoneAddresses]);

    const [selectedZones,setSelectedZones]=useState([]);
    const selectedZonesRef=useRef(selectedZones);
    useEffect(()=>{ selectedZonesRef.current=selectedZones; },[selectedZones]);

    const [results,setResults]=useState([]);
    const [geoData,setGeoData]=useState(FALLBACK_FC);

    /* modal state */
    const [showModal,setShowModal]=useState(false);
    const parsedCount = parseAddresses(addressInput).length;
    const priceTotal = (parsedCount * PRICE_PER_ADDRESS).toFixed(2);

    const loadScript=(src)=>new Promise((res,rej)=>{
      const ex=document.querySelector(`script[src="${src}"]`);
      if(ex){ if(ex.dataset.loaded==='true') return res(); ex.addEventListener('load',()=>res()); ex.addEventListener('error',rej); return; }
      const s=document.createElement('script'); s.src=src; s.async=true;
      s.onload=()=>{s.dataset.loaded='true';res();}; s.onerror=rej; document.body.appendChild(s);
    });
    const loadCSS=(href)=>new Promise((res,rej)=>{
      const ex=document.querySelector(`link[href="${href}"]`); if(ex) return res();
      const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l);
    });

    useEffect(()=>{
      (async()=>{
        try{
          await loadCSS('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');
          await loadScript('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js');
          const L=window.L; if(!L) throw new Error('Leaflet failed to load');
          mapRef.current=L.map(mapEl.current,{minZoom:1.5,worldCopyJump:true,zoomSnap:.25,zoomDelta:.25}).setView([20,0],2.2);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{opacity:.6,attribution:'&copy; OSM'}).addTo(mapRef.current);
          await loadScript('https://unpkg.com/topojson-client@3.1.0/dist/topojson-client.min.js');
          await loadZones(); renderZones();
          mapRef.current.on('click',(e)=>{ if(!e.originalEvent.target.closest?.('.leaflet-interactive')) setSelectedZones([]); });
        }catch(err){ console.error(err); setStatus(err.message||String(err)); }
      })();
      return()=>{try{mapRef.current?.remove();}catch{}};
    },[]);

    useEffect(()=>{ if(mapRef.current) renderZones(); },[geoData,zoneAddresses,selectedZones,theme]);

    async function loadZones(){
      setLoading(true);
      try{
        const r=await fetch(NE_TOPO_URL,{cache:'reload'}); if(!r.ok) throw new Error(`NE TopoJSON HTTP ${r.status}`);
        const topo=await r.json(); const objects=topo?.objects||{}; const keys=Object.keys(objects);
        if(!keys.length) throw new Error('NE TopoJSON: no objects');
        const bestKey=keys.find(k=>/time/i.test(k))||keys[0];
        const fc=window.topojson.feature(topo,objects[bestKey]); const sanit=sanitizeFC(fc);
        if(!sanit) throw new Error('Converted NE data invalid FeatureCollection');
        setGeoData(sanit); setStatus(`Loaded ${sanit.features?.length??0} time zones.`);
      }catch(err){ console.error(err); setGeoData(FALLBACK_FC); setStatus('Fallback polygon.'); }
      finally{ setLoading(false); }
    }

    function renderZones(){
      const L=window.L; if(!L||!mapRef.current||!geoData) return;
      if(tzLayerRef.current){ try{tzLayerRef.current.remove();}catch{} tzLayerRef.current=null; }

      const style=(feature)=>{
        const raw=getZoneName(feature?.properties||{}); const label=polyToUiLabel(raw);
        const countsMap=zoneAddressesRef.current||{}; const max=Math.max(0,...Object.values(countsMap).map(a=>a.length||0));
        const cnt=(countsMap[label]||[]).length||0; const fill=colorForCount(cnt,max);
        const selected = selectedZonesRef.current.includes(label);
        return { color: fill||'#2a3a55', weight: selected?2:1, fillColor: fill||'transparent', fillOpacity: fill ? (selected? .75 : .6) : 0 };
      };

      const onEach=(feature,layer)=>{
        const raw=getZoneName(feature?.properties||{}); const label=polyToUiLabel(raw);
        const cnt=(zoneAddressesRef.current[label]||[]).length||0;
        layer.bindTooltip(`${label} · ${cnt}`,{sticky:true,direction:'top'});
        layer.on('click',()=>{
          setSelectedZones(prev => prev.includes(label) ? prev.filter(z=>z!==label) : [label,...prev]);
          try{ if(layer.getBounds) mapRef.current.fitBounds(layer.getBounds(),{padding:[16,16]}); }catch{}
        });
      };
      tzLayerRef.current=L.geoJSON(geoData,{style,onEachFeature:onEach}).addTo(mapRef.current);
    }

    async function handleDetect(){
      if(!addresses.length) return;
      setDetecting(true); setDetectError('');
      try{
        const zoneMap={}; const perAddr=[];
        for(const addr of addresses){
          const counts=await fetchTxHoursForAddress(addr);
          const pr=predictTimezoneFromCountsSQL(counts);
          const label=pr.utc_label;
          (zoneMap[label]=zoneMap[label]||[]).push(addr);
          perAddr.push({address:addr,utc_label:label,iana:pr.iana_tz_example});
        }
        const zones=Object.keys(zoneMap); if(!zones.length) throw new Error('No timezone returned');
        setZoneAddresses(zoneMap); setSelectedZones(zones); setResults(perAddr);
      }catch(err){ console.error(err); setDetectError(err.message||'Timezone detection failed'); }
      finally{ setDetecting(false); }
    }

    const openConfirm = () => {
      const parsed = parseAddresses(addressInput);
      setAddresses(parsed);
      if(parsed.length === 0) return;
      setShowModal(true);
    };
    const approveAndRun = async () => {
      setShowModal(false);
      await handleDetect();
    };

    const countByLabel=(label)=> (zoneAddresses[label]||[]).length||0;

    function toCSV(rows){
      const header=['Address','Timezone','Timezone Name','Count'].join(',');
      const lines=rows.map(r=>[r.address,r.utc_label,r.iana,countByLabel(r.utc_label)]
        .map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
      return [header,...lines].join('\n');
    }
    function downloadCSV(){
      const csv=toCSV(results); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a');
      a.href=url; a.download='ithil-anor-timezones.csv'; document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    const HeaderArt = () => (
      <svg width="42" height="24" viewBox="0 0 42 24" fill="none" stroke="currentColor" strokeWidth="1.2">
        <circle cx="10" cy="12" r="4" />
        <path d="M10 2v2M10 20v2M2 12H0M20 12h-2" />
        <path d="M34 20a7 7 0 1 1 0-12 5 5 0 0 0 0 12Z" />
      </svg>
    );

    return (
      <div>
        <div className="topbar">
          <div className="brand">
            <HeaderArt/>
            <div>
              <div className="brand-title">Ithil Anor</div>
              <div className="brand-sub">sun · moon — timezone inference</div>
            </div>
          </div>

          <div className="theme-toggle">
            <button className="toggle-btn" onClick={()=>setTheme(t=>t==='sun'?'moon':'sun')}>
              {theme==='sun' ? <MoonIcon/> : <SunIcon/>}
              <span>{theme==='sun' ? 'Moon' : 'Sun'}</span>
            </button>
            <div className="status">{loading ? 'Loading time zones…' : (detecting ? 'Detecting…' : 'Ready')}</div>
          </div>
        </div>

        <div className="grid">
          <div className="card">
            <div className="card-h">
              <div>Map</div>
              <div className="muted">{Object.values(zoneAddresses).reduce((a,arr)=>a+(arr?.length||0),0)} detected</div>
            </div>
            <div className="card-b">
              <div id="map" ref={mapEl}></div>
              {selectedZones.length>0 && (
                <div className="chips">
                  {selectedZones.map(z=>(
                    <span className="chip" key={z}>
                      <span className="dot"></span>
                      {z}
                      <button title="Remove" onClick={()=>setSelectedZones(prev=>prev.filter(p=>p!==z))}>×</button>
                    </span>
                  ))}
                </div>
              )}
            </div>
          </div>

          <div className="card">
            <div className="card-h"><div>Addresses</div><div className="muted">EVM 0x… (one per line or separated)</div></div>
            <div className="card-b">
              <textarea className="input" value={addressInput} onChange={e=>setAddressInput(e.target.value)}
                        placeholder="0xabc...\n0xdef...\n0x123..." />
              <div className="controls" style={{marginTop:'10px'}}>
                <button className="btn primary" onClick={openConfirm} disabled={parsedCount===0 || detecting}>Confirm</button>
                <button className="btn ghost" onClick={downloadCSV} disabled={!results.length}>Download CSV</button>
                <span className="muted">
                  {detecting ? 'Detecting timezones…' : `${parsedCount} address${parsedCount===1?'':'es'} ready`}
                </span>
                {detectError && <span style={{color:'var(--danger)',fontSize:'12px'}}>{detectError}</span>}
              </div>
            </div>
          </div>
        </div>

        <div className="card" style={{marginTop:'14px'}}>
          <div className="card-h">
            <div>Results</div>
            <div className="muted">Per-address timezone (SQL-identical)</div>
          </div>
          <div className="card-b table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Address</th><th>Timezone</th><th>Timezone Name</th><th>Count</th>
                </tr>
              </thead>
              <tbody>
              {results.length===0 ? (
                <tr><td colSpan="4" className="muted" style={{padding:'10px'}}>Paste addresses and click Confirm.</td></tr>
              ) : (
                results.map((r,i)=>(
                  <tr key={r.address+i}>
                    <td className="mono">{r.address}</td>
                    <td>{r.utc_label}</td>
                    <td>{r.iana}</td>
                    <td>{(zoneAddresses[r.utc_label]||[]).length||0}</td>
                  </tr>
                ))
              )}
              </tbody>
            </table>
          </div>
        </div>

        <div className="muted" style={{fontSize:'12px',marginTop:'10px'}}>
          Natural Earth time zones (TopoJSON). EVM activity via SIM (all chains, send+receive). © OSM contributors.
        </div>

        {showModal && (
          <div className="modal-backdrop" role="dialog" aria-modal="true">
            <div className="modal-card">
              <div className="modal-h">
                <div>Confirm Detection</div>
                <button className="btn ghost" onClick={()=>setShowModal(false)}>×</button>
              </div>
              <div className="modal-b">
                <div style={{marginBottom:'8px'}}>We will analyze <strong>{parsedCount}</strong> address{parsedCount===1?'':'es'}.</div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:'6px'}}>
                  <div className="muted">Price</div>
                  <div>$0.50 / address</div>
                </div>
                <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginTop:'6px',fontWeight:800}}>
                  <div>Total</div>
                  <div>${priceTotal}</div>
                </div>
              </div>
              <div className="modal-f">
                <button className="btn" onClick={()=>setShowModal(false)}>Cancel</button>
                <button className="btn primary" onClick={approveAndRun} disabled={detecting}>Approve & Run</button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
